<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="app.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>Estação de sensoriamento</title>
</head>
<body> 
    <div class="main">
        <h2 align="center"> Problema 3 -  IoT: A Internet das Coisas</h2>
        <h3 align="center"> Danrlei Araujo e Evelyn Suzarte</h3>   
        <canvas id="myChart"></canvas>
    </div> 

    <script>        

            //função para adicionar e remover informações
            function add_data(label, data) {
                myChart.data.labels.push(label);
                myChart.data.datasets.forEach((dataset) => {
                    dataset.data.push(data);
                });
                myChart.update();
            }

            function remove_firstData() {
                myChart.data.labels.splice(0, 1);
                myChart.data.datasets.forEach((dataset) => {
                    dataset.data.shift();
                });
            }

            //construção do gráfico
            const ctx = document.getElementById('myChart').getContext("2d");
            const myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{ label: "Valor do sensor", }],
                    backgroundColor: "purple",
                    borderColor: "purple",
                },
                options:{
                    resposive: true
                }
            });

            //configuração do mqtt
            const contador_max = 10;

            const mqtt = require('mqtt')
            const url = 'tcp://10.0.0.101:1883@@luno*123'
            const topic = 'front'
            const resultado = []

            // Cria configuração de conexão mqtt
            const options = {
                clean: true,
                clientId: 'SBC',
                username: 'aluno',
                password: '@luno*123',
            }
            const client  = mqtt.connect(url, options)

            client.on('connect', function () {
                if(!err){
                    console.log('------------ Conectado! -------------');
                    client.subscribe(topic);
                } else{
                    console.log("Não conectado!");
                }
            });

            client.on(topic, function (message) {
                console.log(message.toString());
                const messageTemp = message.toString();

                resultado = messageTemp.split(",", 4);  //data/ Node x/ pino/ informação
                // var data = resultado[0]
                // var node = resultado[1]
                // var pino = resultado[2]
                // var informacao = resultado[3]

                console.log("Recebendo:", + resultado[0] + "Node: " + 
                            resultado[1] + "----->" + resultado[2] + " : " + resultado[3]);
                
                const message_x = resultado[1]+resultado[2]+"-->"+resultado[3];             
                if(myChart.data.labels.length > contador_max) {
                    remove_firstData();
                }
                
                add_data(resultado[0], message_x);

                client.end();
            });

    </script>

</body>
</html>